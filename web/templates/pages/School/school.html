{% extends 'core/base.html' %} {% load static %} {% block content %}

<div class="container-fluid py-4 pt-3">
  <div class="row">
    <div class="col">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <div class="d-flex item-center justify-content-between">
            <div class="p-2 flex-grow-1">
              <h6 class="font-weight-bolder text-lg">School Lists</h6>
            </div>
            <div class="p-2">
              <a href="{% url 'add_school' %}" class="btn bg-gradient-success"
                >Add School</a
              >
            </div>
            <div class="p-2">
              <input
                id="searchInput"
                type="text"
                class="form-control"
                placeholder="Type here..."
                onfocus="focused(this)"
                onfocusout="defocused(this)"
              />
            </div>
          </div>
        </div>
        <div class="card-body px-2 pt-0 pb-2 pt-2">
          <div class="table-responsive p-0 overflow-hidden">
            <table
              class="table align-items-center mb-0 table-striped table-hover"
            >
              <thead class="h6">
                <tr>
                  <th class="text-uppercase text-sm font-weight-bolder ps-2">
                    School Name
                  </th>
                  <th
                    class="align-middle text-uppercase text-sm font-weight-bolder ps-2"
                  >
                    School ID
                  </th>
                  <th
                    class="align-middle text-uppercase text-sm font-weight-bolder text-end"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="employeeTable">
                {% for school in school_list %}
                <tr id="{{ school.id }}">
                  <td class="w-50">
                    <p class="text-sm font-weight-bold mb-0">
                      {{ school.name }}
                    </p>
                  </td>
                  <td class="align-middle text-sm">
                    <p class="text-sm font-weight-bold mb-0">{{ school.id }}</p>
                  </td>
                  <td class="align-middle text-sm text-end">
                    <button
                      class="btn bg-gradient-warning btn-tooltip mb-0 p-2"
                      onclick="editRow(this, {{school.id}})"
                      type="button"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Edit"
                      data-container="body"
                      data-animation="true"
                    >
                      Edit
                    </button>
                    <button
                      class="btn bg-gradient-danger btn-tooltip mb-0 p-2"
                      onclick="deleteUser({{ school.id }})"
                      type="button"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Delete"
                      data-container="body"
                      data-animation="true"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  var newRow = $(`{% include 'core/editBox.html' %}`);

  $("#searchInput").on("keyup", function () {
    var value = $(this).val().toLowerCase();
    if (value !== "") {
      $.ajax({
        url: "/search_schools/",
        method: "POST",
        data: {
          csrfmiddlewaretoken: `{{csrf_token}}`,
          search: value,
        },
        success: function (data) {
          $("#searchResultsList").empty();
          if (data.length > 0) {
            $("#searchResultsRow").show();
            $("#employeeTable").empty();
            $.each(data, function (id, school) {
              $("#employeeTable").append(`
                <tr id="${school.id}">
                  <td class="w-50">
                    <p class="text-sm font-weight-bold mb-0">${school.id}</p>
                  </td>
                  <td class="align-middle text-sm">
                    <p class="text-sm font-weight-bold mb-0">${school.name}</p>
                  </td>
                  <td class="align-middle text-sm">
                    <button class="btn bg-gradient-warning btn-tooltip mb-0 p-2" onclick="editRow(this, ${school.id})" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit" data-container="body" data-animation="true">
                      Edit
                    </button>
                    <button class="btn bg-gradient-danger btn-tooltip mb-0 p-2" onclick="deleteUser(${school.id})" type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete" data-container="body" data-animation="true">
                      Delete
                    </button>
                  </td>
                </tr>
              `);
            });
          } else {
            $("#searchResultsRow").hide();
          }
        },
      });
    } else {
      $("#searchResultsRow").hide();
    }
  });

  function editRow(button, schoolId) {
    var targetRowId = $(button).closest("tr").attr("id");
    var editBox = $("#editBox");

    if (editBox.length > 0) {
      editBox.remove();
    } else {
      var newRow = $(`{% include 'core/editBox.html' %}`).attr(
        "data-school-id",
        schoolId
      );

      newRow.find("#schoolIdInput").val(schoolId);

      $("#" + targetRowId).after(newRow);

      $.ajax({
        url: `/get_school/${schoolId}/`,
        method: "GET",
        success: function (school) {
          $("#SchoolName").val(school.name);

          $("#form").attr("action", `/update_school/${schoolId}/`);

          $("#form").submit(function (e) {
            e.preventDefault();
            editRowWithAjax(schoolId);
          });
        },
        error: function (xhr, status, error) {
          console.error("Error fetching school details:", status, error);
        },
      });
    }
  }

  function deleteUser(schoolId) {
    if (confirm("Are you sure you want to delete this school?")) {
      $.ajax({
        url: `/delete_school/${schoolId}/`,
        method: "POST",
        data: {
          csrfmiddlewaretoken: `{{ csrf_token }}`,
        },
        success: function () {
          $("#" + schoolId).remove();
        },
        error: function (xhr, status, error) {
          console.error("Error deleting school:", status, error);
        },
      });
    }
  }

  function editRowWithAjax(schoolId) {
    $.ajax({
      url: `/update_school/${schoolId}/`,
      method: "POST",
      data: $("#form").serialize(),
      success: function (response) {
        if (response.status === "Success") {
          alert(response.message);
          window.location.reload(true);
          console.log("Update successful:", response.message);
        } else {
          console.error("Update failed:", response.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("Error updating school:", status, error);
      },
    });
  }
</script>

{% endblock %}
